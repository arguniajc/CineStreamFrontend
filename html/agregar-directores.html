<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agregar Directores a la Película</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background-color: #f4f4f4;
    }

    h1, h2 {
      color: #333;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button {
      margin-top: 20px;
      padding: 10px 15px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #218838;
    }

    #btnSiguiente {
      background-color: #007bff;
    }

    #btnSiguiente:hover {
      background-color: #0069d9;
    }

    .feedback {
      margin-top: 15px;
      font-weight: bold;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }

    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .director-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 200px;
      padding: 15px;
      text-align: center;
    }

    .director-card h4 {
      margin: 5px 0;
      font-size: 16px;
      color: #333;
    }

    .director-card p {
      margin: 0;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>

  <h1>Agregar Directores a la Película</h1>
  <p id="peliculaIdInfo"></p>

  <label for="directorSelect">Selecciona un director:</label>
  <select id="directorSelect">
    <option value="">-- Selecciona un director --</option>
  </select>

  <button id="btnAgregarDirector">Agregar a la película</button>

  <div class="feedback" id="mensaje"></div>

  <h2>Directores Asociados:</h2>
  <div id="listaDirectores" class="card-container"></div>

  <!-- Botón Siguiente -->
  <button id="btnSiguiente">Siguiente: Agregar Compañías</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const peliculaId = urlParams.get("peliculaId");

    const directorSelect = document.getElementById("directorSelect");
    const listaDirectores = document.getElementById("listaDirectores");
    const mensaje = document.getElementById("mensaje");

    const directoresCargados = {};

    document.getElementById("peliculaIdInfo").textContent = "Película ID: " + peliculaId;

    async function cargarDirectores() {
      try {
        const response = await fetch("http://localhost:3000/api/directores");
        const directores = await response.json();

        directores.forEach(director => {
          directoresCargados[director.id] = director;
          const option = document.createElement("option");
          option.value = director.id;
          option.textContent = director.nombre;
          directorSelect.appendChild(option);
        });
      } catch (err) {
        mensaje.innerHTML = `<span class="error">⚠️ Error cargando directores: ${err.message}</span>`;
      }
    }

    async function cargarDirectoresDePelicula() {
      try {
        const response = await fetch("http://localhost:3000/api/pelicula_director");
        const datos = await response.json();

        const relacionados = datos.filter(item => item.id_pelicula == peliculaId);

        if (relacionados.length === 0) {
          listaDirectores.innerHTML = "<p>No hay directores asociados a esta película.</p>";
          return;
        }

        listaDirectores.innerHTML = "";

        relacionados.forEach(item => {
          const card = document.createElement("div");
          card.className = "director-card";

          const img = document.createElement("img");
          img.src = item.imagen_director || "https://via.placeholder.com/200x200?text=Sin+Imagen";
          img.alt = item.nombre_director;
          img.style.width = "100%";
          img.style.height = "220px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "5px";
          img.style.marginBottom = "10px";

          const h4 = document.createElement("h4");
          h4.textContent = item.nombre_director;

          card.appendChild(img);
          card.appendChild(h4);

          listaDirectores.appendChild(card);
        });

      } catch (err) {
        mensaje.innerHTML = `<span class="error">⚠️ Error al cargar directores de la película: ${err.message}</span>`;
      }
    }

    document.getElementById("btnAgregarDirector").addEventListener("click", async () => {
      const directorId = directorSelect.value;

      if (!peliculaId || !directorId) {
        mensaje.innerHTML = `<span class="error">❌ Debes seleccionar un director válido.</span>`;
        return;
      }

      const payload = {
        id_pelicula: parseInt(peliculaId),
        id_director: parseInt(directorId)
      };

      try {
        const response = await fetch("http://localhost:3000/api/pelicula_director/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!response.ok) {
          mensaje.innerHTML = `<span class="error">❌ Error: ${result.error || 'Error inesperado.'}</span>`;
          return;
        }

        mensaje.innerHTML = `<span class="success">✅ Director agregado correctamente.</span>`;
        await cargarDirectoresDePelicula();
        directorSelect.value = "";
      } catch (err) {
        mensaje.innerHTML = `<span class="error">⚠️ Error al agregar director: ${err.message}</span>`;
      }
    });

    // Redirección al siguiente paso
    document.getElementById("btnSiguiente").addEventListener("click", () => {
      if (peliculaId) {
        window.location.href = `agregar-companias.html?peliculaId=${peliculaId}`;
      } else {
        mensaje.innerHTML = `<span class="error">⚠️ No se encontró el ID de la película para continuar.</span>`;
      }
    });

    if (peliculaId) {
      cargarDirectores().then(() => cargarDirectoresDePelicula());
    } else {
      mensaje.innerHTML = `<span class="error">❌ No se proporcionó el ID de la película en la URL.</span>`;
    }
  </script>
</body>
</html>
