<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Agregar Actores a la Película</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 30px;
      background-color: #f4f4f4;
    }

    h1, h2 {
      color: #333;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    select, input[type="text"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button {
      margin-top: 20px;
      padding: 10px 15px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #0056b3;
    }

    .feedback {
      margin-top: 15px;
      font-weight: bold;
    }

    .success {
      color: green;
    }

    .error {
      color: red;
    }

    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }

    .actor-card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      width: 200px;
      padding: 15px;
      text-align: center;
    }

    .actor-card img {
      width: 100%;
      height: 220px;
      object-fit: cover;
      border-radius: 5px;
      margin-bottom: 10px;
    }

    .actor-card h4 {
      margin: 5px 0;
      font-size: 16px;
      color: #333;
    }

    .actor-card p {
      margin: 0;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>
<body>

  <h1>Agregar Actores a la Película</h1>
  <p id="peliculaIdInfo"></p>

  <label for="actorSelect">Selecciona un actor:</label>
  <select id="actorSelect">
    <option value="">-- Selecciona un actor --</option>
  </select>

  <label for="personajeInput">Nombre del personaje:</label>
  <input type="text" id="personajeInput" placeholder="Ej: Tony Stark" />

  <button id="btnAgregarActor">Agregar a la película</button>

  <div class="feedback" id="mensaje"></div>

  <h2>Actores Seleccionados:</h2>
  <div id="listaActores" class="card-container"></div>

  <!-- Botón para ir a agregar directores -->
  <br><br>
  <button onclick="irADirectores()">Siguiente: Agregar Directores</button>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const peliculaId = urlParams.get("peliculaId");

    const actorSelect = document.getElementById("actorSelect");
    const personajeInput = document.getElementById("personajeInput");
    const listaActores = document.getElementById("listaActores");
    const mensaje = document.getElementById("mensaje");

    const actoresCargados = {};

    document.getElementById("peliculaIdInfo").textContent = "Película ID: " + peliculaId;

    async function cargarActores() {
      try {
        const response = await fetch("http://localhost:3000/api/actores");
        const actores = await response.json();

        actores.forEach(actor => {
          actoresCargados[actor.id] = actor;
          const option = document.createElement("option");
          option.value = actor.id;
          option.textContent = actor.nombre;
          actorSelect.appendChild(option);
        });
      } catch (err) {
        mensaje.innerHTML = `<span class="error">⚠️ Error cargando actores: ${err.message}</span>`;
      }
    }

    async function cargarActoresDePelicula(peliculaId) {
      try {
        const response = await fetch("http://localhost:3000/api/pelicula-actor");
        const datos = await response.json();

        const relacionesFiltradas = datos.filter(item => item.id_pelicula == peliculaId);

        if (relacionesFiltradas.length === 0) {
          listaActores.innerHTML = "<p>No hay actores asociados a esta película.</p>";
          return;
        }

        listaActores.innerHTML = "";

        relacionesFiltradas.forEach(item => {
          const card = document.createElement("div");
          card.className = "actor-card";

          const actorInfo = actoresCargados[item.id_actor] || {};
          const imagen = actorInfo.imagen_url || "https://via.placeholder.com/200x220?text=Sin+Foto";

          card.innerHTML = `
            <img src="${imagen}" alt="${item.actor?.nombre || 'Actor'}">
            <h4>${item.actor?.nombre || 'Nombre desconocido'}</h4>
            <p>Personaje: ${item.personaje}</p>
          `;

          listaActores.appendChild(card);
        });

      } catch (err) {
        mensaje.innerHTML = `<span class="error">⚠️ Error al consultar actores de la película: ${err.message}</span>`;
      }
    }

    document.getElementById("btnAgregarActor").addEventListener("click", async () => {
      const actorId = actorSelect.value;
      const personaje = personajeInput.value.trim();

      if (!peliculaId || !actorId || !personaje) {
        mensaje.innerHTML = `<span class="error">❌ Debes seleccionar un actor y escribir un personaje.</span>`;
        return;
      }

      const payload = {
        id_pelicula: parseInt(peliculaId),
        id_actor: parseInt(actorId),
        personaje
      };

      try {
        const response = await fetch("http://localhost:3000/api/pelicula-actor/", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const result = await response.json();

        if (!response.ok) {
          mensaje.innerHTML = `<span class="error">❌ Error: ${result.error || 'Error inesperado.'}</span>`;
          return;
        }

        mensaje.innerHTML = `<span class="success">✅ Actor agregado correctamente.</span>`;
        await cargarActoresDePelicula(peliculaId);
        limpiarFormulario();
      } catch (err) {
        mensaje.innerHTML = `<span class="error">⚠️ Error al agregar actor: ${err.message}</span>`;
      }
    });

    function limpiarFormulario() {
      actorSelect.value = "";
      personajeInput.value = "";
    }

    function irADirectores() {
      if (!peliculaId) {
        mensaje.innerHTML = `<span class="error">❌ No se puede continuar: Falta el ID de la película.</span>`;
        return;
      }
      window.location.href = `agregar-directores.html?peliculaId=${peliculaId}`;
    }

    if (peliculaId) {
      cargarActores().then(() => cargarActoresDePelicula(peliculaId));
    } else {
      mensaje.innerHTML = `<span class="error">❌ No se proporcionó el ID de la película en la URL.</span>`;
    }
  </script>
</body>
</html>
